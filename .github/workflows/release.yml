name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          check-latest: true
          go-version-file: go.mod
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev build-essential pkg-config mingw-w64 binutils-mingw-w64 icoutils imagemagick
          # Ubuntu 24.04 (noble) uses libwebkit2gtk-4.1-dev; fallback to 4.0 for older distros
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
          # Optional but recommended for some webview builds
          sudo apt-get install -y libsoup-3.0-dev || true
          # Provide a pkg-config alias so libraries expecting webkit2gtk-4.0 will work on 24.04
          if [ -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          # Verify pkg-config can resolve at least one WebKitGTK version
          pkg-config --exists webkit2gtk-4.0 || pkg-config --exists webkit2gtk-4.1
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm
      - name: Build and Package
        run: |
          # 1. Extract Version
          VERSION=$(python3 -c "import json; print(json.load(open('version.json'))['code'])")
          echo "Detected Version: $VERSION"
          export VERSION

          # 2. Update wails.json version
          python3 -c "import json; data=json.load(open('wails.json')); data['info']['productVersion']='$VERSION'; json.dump(data, open('wails.json', 'w'), indent=2)"

          # 3. Environment Setup
          export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:${PKG_CONFIG_PATH}"
          mkdir -p build/artifacts

          # 4. Build
          cd frontend && npm install && cd ..
          wails build -platform linux/amd64 -clean -ldflags "-s -w"
          
          if [ ! -f build/bin/0xDABmusic ]; then echo "Linux build failed"; exit 1; fi

          # 5. Package (NFPM)
          nfpm pkg --packager deb --target build/bin/
          nfpm pkg --packager archlinux --target build/bin/

          # 6. Zip Artifacts
          cd build/bin
          zip -r "../artifacts/0xDABmusic_${VERSION}_linux_amd64.zip" "0xDABmusic"
          zip -r "../artifacts/0xDABmusic_${VERSION}_linux_deb.zip" *.deb
          zip -r "../artifacts/0xDABmusic_${VERSION}_linux_arch.zip" *.pkg.tar.zst
          cd ../..
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
      
      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: build/artifacts/*

  build-windows:
    needs: build-linux
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - name: Install NSIS
        run: |
          choco install nsis
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
      - name: Build and Package
        shell: bash
        run: |
          VERSION=$(python3 -c "import json; print(json.load(open('version.json'))['code'])")
          
          # Build Binary
          wails build -platform windows/amd64 -clean -ldflags "-s -w"
          
          # Prepare Directories
          mkdir -p build/artifacts
          
          # Check Binary
          if [ ! -f "build/bin/0xDABmusic.exe" ]; then
             echo "Windows build failed!"
             exit 1
          fi

          # Create Installer via NSIS
          makensis -DVERSION="$VERSION" build/windows/installer.nsi
          
          # Bundle artifacts into single zip
          cd build/artifacts
          
          # Rename standalone exe
          cp ../bin/0xDABmusic.exe "0xDABmusic_Portable_${VERSION}.exe"
          
          # Zip both Setup and Portable into one bundle
          7z a -tzip "0xDABmusic_${VERSION}_windows_bundle.zip" "0xDABmusic_Setup_${VERSION}.exe" "0xDABmusic_Portable_${VERSION}.exe"
          
          # Cleanup raw files so they aren't uploaded
          rm "0xDABmusic_Setup_${VERSION}.exe" "0xDABmusic_Portable_${VERSION}.exe"
          
          cd ../..

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*.zip
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
    
      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: build/artifacts/*.zip

  build-macos:
    needs: build-linux
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install macOS Tools
        run: brew install create-dmg

      - name: Build and Package
        run: |
          # 1. Extract Version
          VERSION=$(python3 -c "import json; print(json.load(open('version.json'))['code'])")
          echo "Building version: $VERSION"
          
          # Update Info.plist with dynamic version
          plutil -replace CFBundleShortVersionString -string "$VERSION" build/darwin/Info.plist
          plutil -replace CFBundleVersion -string "$VERSION" build/darwin/Info.plist

          # 2. Build Universal Binary (Intel + Apple Silicon)
          wails build -platform darwin/universal -clean -ldflags "-s -w"

          # 3. Ad-Hoc Code Signing
          echo "Applying Ad-Hoc Signature..."
          codesign --deep --force --verbose --sign "-" "build/bin/0xDABmusic.app"

          # 4. Prepare Artifacts
          mkdir -p build/artifacts
          
          # 5. Create DMG Installer
          echo "Creating DMG Installer..."
          create-dmg \
            --volname "0xDABmusic Installer" \
            --volicon "build/bin/0xDABmusic.app/Contents/Resources/icon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "0xDABmusic.app" 200 190 \
            --hide-extension "0xDABmusic.app" \
            --app-drop-link 600 185 \
            "build/artifacts/0xDABmusic_${VERSION}_macos_universal.dmg" \
            "build/bin/0xDABmusic.app"

          # 6. Bundle App and DMG into single Zip
          cd build/bin
          cp "../../build/artifacts/0xDABmusic_${VERSION}_macos_universal.dmg" .
          zip -r "../../build/artifacts/0xDABmusic_${VERSION}_macos_bundle.zip" "0xDABmusic.app" "0xDABmusic_${VERSION}_macos_universal.dmg"
          cd ../..
          
          # Cleanup raw dmg so only the bundle is uploaded
          rm "build/artifacts/0xDABmusic_${VERSION}_macos_universal.dmg"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*.zip
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: build/artifacts/*.zip

  scan-and-update-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Scan with VirusTotal and Update Release
        env:
          VT_API_KEY: ${{ secrets.VT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "Starting VirusTotal Scan..."
          # Function to scan file
          scan_file() {
            local filepath="$1"
            local filename=$(basename "$filepath")
            echo "Scanning $filename..."
            
            # Upload file to VirusTotal
            resp=$(curl --request POST \
              --url "https://www.virustotal.com/api/v3/files" \
              --header "x-apikey: $VT_API_KEY" \
              --form "file=@$filepath")
            
            # Extract Analysis ID
            id=$(echo "$resp" | jq -r '.data.id')
            
            if [ "$id" == "null" ] || [ -z "$id" ]; then
              echo "Failed to upload $filename to VirusTotal."
              echo "Response: $resp"
              return 1
            fi
            
            # Check for existing sha256 to avoid waiting for re-analysis if already known? 
            # VT API v3 /files upload returns analysis id directly.
            
            # Construct Link (using the SHA256 of the file for the direct report link usually, or analysis link)
            # Actually, standard VT link is /gui/file/<sha256>/detection
            sha256=$(sha256sum "$filepath" | awk '{print $1}')
            link="https://www.virustotal.com/gui/file/$sha256/detection"
            
            echo "- ðŸ›¡ï¸ **$filename**: [VirusTotal Scan Result]($link)" >> scan_results.md
          }

          touch scan_results.md
          echo "### ðŸ›¡ï¸ VirusTotal Scan Results" >> scan_results.md
          echo "" >> scan_results.md
          
          # Scan all zip files
          find artifacts -name "*.zip" | while read -r file; do
             scan_file "$file"
          done

          echo "" >> scan_results.md
          echo "â„¹ï¸ _Note: VirusTotal results may take a few moments to populate if this is the first time the file has been seen._" >> scan_results.md
          
          # Prepare Release Body Update
          # We want to prepend generic info and append scan results
          
          echo "Updating Release Description..."
          
          CURRENT_BODY=$(gh release view "$TAG_NAME" --json body -q .body)
          
          echo "### ðŸ“€ Installation Recommended" > new_body.md
          echo "" >> new_body.md
          echo "> **Windows Users**: Please use the **Setup** file for the best experience." >> new_body.md
          echo "" >> new_body.md
          echo "> âš ï¸ **Linux & macOS**: These builds are currently **UNTESTED**. Please report any issues!" >> new_body.md
          echo "" >> new_body.md
          
          echo "$CURRENT_BODY" >> new_body.md
          
          echo "" >> new_body.md
          cat scan_results.md >> new_body.md
          
          gh release edit "$TAG_NAME" --notes-file new_body.md
          
  deploy-pages:
    needs: scan-and-update-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GIT_TOKEN }}
          publish_dir: ./website
