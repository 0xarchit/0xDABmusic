name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          check-latest: true
          go-version-file: go.mod
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev build-essential pkg-config mingw-w64 binutils-mingw-w64 icoutils imagemagick
          # Ubuntu 24.04 (noble) uses libwebkit2gtk-4.1-dev; fallback to 4.0 for older distros
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
          # Optional but recommended for some webview builds
          sudo apt-get install -y libsoup-3.0-dev || true
          # Provide a pkg-config alias so libraries expecting webkit2gtk-4.0 will work on 24.04
          if [ -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          # Verify pkg-config can resolve at least one WebKitGTK version
          pkg-config --exists webkit2gtk-4.0 || pkg-config --exists webkit2gtk-4.1
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm
      - name: Build and Package
        run: |
          chmod +x build_release.sh
          ./build_release.sh linux
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
      
      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: build/artifacts/*

  build-windows:
    needs: build-linux
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - name: Install NSIS
        run: |
          choco install nsis
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
      - name: Build and Package
        shell: bash
        run: |
          VERSION=$(python3 -c "import json; print(json.load(open('version.json'))['code'])")
          
          # Build Binary
          wails build -platform windows/amd64 -clean -ldflags "-s -w"
          
          # Prepare Directories
          mkdir -p build/artifacts
          
          # Check Binary
          if [ ! -f "build/bin/0xDABmusic.exe" ]; then
             echo "Windows build failed!"
             exit 1
          fi

          # Create Installer via NSIS
          # makensis is available on windows-latest runner
          makensis -DVERSION="$VERSION" build/windows/installer.nsi
          
          # Zip the Installer (Setup) and the standalone Exe
          cd build/artifacts
          
          # Zip Installer if it exists
          if [ -f "0xDABmusic_Setup_${VERSION}.exe" ]; then
            7z a -tzip "0xDABmusic_Setup_${VERSION}.zip" "0xDABmusic_Setup_${VERSION}.exe"
            rm "0xDABmusic_Setup_${VERSION}.exe" # Remove original to verify only zip is uploaded
          fi
          
          # Also package standalone exe just in case people want it
          cp ../bin/0xDABmusic.exe "0xDABmusic_Portable_${VERSION}.exe"
          7z a -tzip "0xDABmusic_Portable_${VERSION}.zip" "0xDABmusic_Portable_${VERSION}.exe"
          rm "0xDABmusic_Portable_${VERSION}.exe"
          
          cd ../..

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*.zip
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
    
      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: build/artifacts/*.zip

  build-macos:
    needs: build-windows
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - name: Build and Package
        run: |
          chmod +x build_release.sh
          ./build_release.sh
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/artifacts/*
          token: ${{ secrets.GIT_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Upload Artifacts for Scanning
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: build/artifacts/*

  scan-and-update-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Scan with VirusTotal and Update Release
        env:
          VT_API_KEY: ${{ secrets.VT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "Starting VirusTotal Scan..."
          # Function to scan file
          scan_file() {
            local filepath="$1"
            local filename=$(basename "$filepath")
            echo "Scanning $filename..."
            
            # Upload file to VirusTotal
            resp=$(curl --request POST \
              --url "https://www.virustotal.com/api/v3/files" \
              --header "x-apikey: $VT_API_KEY" \
              --form "file=@$filepath")
            
            # Extract Analysis ID
            id=$(echo "$resp" | jq -r '.data.id')
            
            if [ "$id" == "null" ] || [ -z "$id" ]; then
              echo "Failed to upload $filename to VirusTotal."
              echo "Response: $resp"
              return 1
            fi
            
            # Check for existing sha256 to avoid waiting for re-analysis if already known? 
            # VT API v3 /files upload returns analysis id directly.
            
            # Construct Link (using the SHA256 of the file for the direct report link usually, or analysis link)
            # Actually, standard VT link is /gui/file/<sha256>/detection
            sha256=$(sha256sum "$filepath" | awk '{print $1}')
            link="https://www.virustotal.com/gui/file/$sha256/detection"
            
            echo "- ðŸ›¡ï¸ **$filename**: [VirusTotal Scan Result]($link)" >> scan_results.md
          }

          touch scan_results.md
          echo "### ðŸ›¡ï¸ VirusTotal Scan Results" >> scan_results.md
          echo "" >> scan_results.md
          
          # Scan all zip files
          find artifacts -name "*.zip" | while read -r file; do
             scan_file "$file"
          done

          echo "" >> scan_results.md
          echo "â„¹ï¸ _Note: VirusTotal results may take a few moments to populate if this is the first time the file has been seen._" >> scan_results.md
          
          # Prepare Release Body Update
          # We want to prepend generic info and append scan results
          
          echo "Updating Release Description..."
          
          CURRENT_BODY=$(gh release view "$TAG_NAME" --json body -q .body)
          
          # Add "Setup is Preferred" note if not present
          NOTE="### ðŸ“€ Installation Recommended\n\n> **Windows Users**: Please use the **Setup** file for the best experience (Desktop shortcuts, Uninstaller, etc).\n\n"
          
          NEW_BODY="$NOTE$CURRENT_BODY\n\n$(cat scan_results.md)"
          
          gh release edit "$TAG_NAME" --notes "$NEW_BODY"
          
  deploy-pages:
    needs: scan-and-update-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GIT_TOKEN }}
          publish_dir: ./website
