services:
  builder:
    build: .
    image: 0xdabmusic-builder
    volumes:
      - .:/app
      # Isolate Linux node_modules from Windows host
      - frontend_node_modules:/app/frontend/node_modules
    environment:
      - VERSION
    command: >
      bash -c "
      echo 'Building Linux Binary...' &&
      cd frontend && 
      rm -rf package-lock.json &&
      find node_modules -mindepth 1 -delete 2>/dev/null || true &&
      npm install --no-package-lock && 
      cd .. &&
      wails build -platform linux/amd64 -ldflags '-s -w' &&
      echo 'Packaging .deb...' &&
      nfpm pkg --packager deb --target build/bin/ &&
      echo 'Packaging Arch Linux...' &&
      nfpm pkg --packager archlinux --target build/bin/ &&
      echo 'Linux Build Complete!'
      "

volumes:
  frontend_node_modules:
